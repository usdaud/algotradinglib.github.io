# Бэктестинг на Python

Бэктестинг — ключевое понятие в алгоритмической торговле. Он заключается в проверке торговой стратегии на исторических данных, чтобы оценить ее эффективность. Симулируя стратегию на прошлых данных, трейдеры получают представление о том, как она может работать в реальных условиях, не рискуя реальным капиталом.

Python стал одним из основных языков для бэктестинга благодаря богатой экосистеме библиотек и фреймворков для финансового анализа и автоматизации торговли. Ниже рассмотрены основы бэктестинга на Python, ключевые библиотеки, концепции и пример реализации.

## Базовые понятия бэктестинга

Перед тем как перейти к Python, важно понять базовые элементы бэктестинга:

- **Исторические данные**: временные ряды по инструментам — цены, объемы и рыночные индикаторы.
- **Логика стратегии**: правила входа и выхода, основанные на индикаторах, статистике или других критериях.
- **Метрики эффективности**: показатели, такие как чистая прибыль, ROI, коэффициент Шарпа и максимальная просадка.
- **Транзакционные издержки**: комиссии, спреды и проскальзывание, которые возникают в реальной торговле.

## Популярные библиотеки Python для бэктестинга

Существует много библиотек, предоставляющих инструменты для бэктестинга торговых стратегий. Наиболее популярные:

### 1. Backtrader

Backtrader — универсальный фреймворк для бэктестинга и торговли. Он поддерживает несколько источников данных, индикаторы и многое другое.

- Документация: Backtrader

### 2. Zipline

Zipline — библиотека с открытым исходным кодом, изначально разработанная Quantopian (проект закрыт в ноябре 2020). Сейчас поддерживается сообществом как zipline-reloaded.

- Документация: Zipline

### 3. PyAlgoTrade

PyAlgoTrade — библиотека с открытым исходным кодом, ориентированная на высокочастотные стратегии.

- Документация: PyAlgoTrade

### 4. BT (Backtesting.py)

BT — гибкая библиотека для простого анализа стратегий и оптимизации.

- Документация: BT

### 5. QuantConnect

QuantConnect предлагает полноценную платформу алгоритмической торговли с встроенным бэктестингом и интеграциями.

- Документация: QuantConnect

### 6. Forex-Python

Библиотека для работы с валютными курсами, которые можно использовать в стратегиях бэктестинга.

- Документация: Forex-Python

### 7. TA-Lib

TA-Lib предоставляет набор индикаторов финансового рынка для использования в логике стратегий.

- Документация: TA-Lib

## Основные шаги реализации стратегии

Упрощенный рабочий процесс бэктестинга на Python:

1. **Сбор данных**: получение исторических данных.
2. **Предобработка**: очистка и трансформация данных.
3. **Определение стратегии**: реализация логики торговли.
4. **Запуск бэктеста**: применение стратегии к историческим данным.
5. **Оценка эффективности**: анализ результатов.
6. **Оптимизация и валидация**: настройка параметров и проверка на переобучение.

### Пример: стратегия пересечения скользящих средних

Ниже — пример реализации простой стратегии с использованием Backtrader:

```python
import backtrader as bt
import datetime

# Create a Strategy
class SmaCross(bt.SignalStrategy):
    def __init__(self):
        sma1, sma2 = bt.ind.SMA(period=10), bt.ind.SMA(period=30)
        crossover = bt.ind.CrossOver(sma1, sma2)
        self.signal_add(bt.SIGNAL_LONG, crossover)

# Init Cerebro
cerebro = bt.Cerebro()
cerebro.addstrategy(SmaCross)

# Data Feed
data = bt.feeds.YahooFinanceData(dataname='AAPL',
                                 fromdate=datetime.datetime(2015, 1, 1),
                                 todate=datetime.datetime(2020, 12, 31))
cerebro.adddata(data)

# Set Cash
cerebro.broker.setcash(10000)

# Run and Plot
print('Starting Portfolio Value: %.2f' % cerebro.broker.getvalue())
cerebro.run()
print('Ending Portfolio Value: %.2f' % cerebro.broker.getvalue())
cerebro.plot()
```

В этом примере:
- Определяется стратегия `SmaCross`, открывающая лонг при пересечении короткой средней вверх.
- Инициализируется движок `cerebro` и добавляется стратегия.
- Подключается источник данных Yahoo Finance для акций Apple (AAPL).
- Задается стартовый капитал.
- Запускается бэктест и строится график результатов.

## Метрики эффективности

Анализ метрик эффективности позволяет понять, насколько стратегия пригодна для реальной торговли. Ниже — основные метрики.

### 1. Чистая прибыль

Чистая прибыль — разница между итоговым и начальным капиталом.

```python
total_cash = cerebro.broker.getvalue()
initial_cash = 10000
net_profit = total_cash - initial_cash
print('Net Profit: %.2f' % net_profit)
```

### 2. ROI

ROI показывает доходность инвестиций относительно начального капитала.

```python
roi = (total_cash / initial_cash - 1) * 100
print('ROI: %.2f%%' % roi)
```

### 3. Коэффициент Шарпа

Коэффициент Шарпа оценивает риск-скорректированную доходность.

```python
returns = [original_value - new_value for original_value, new_value in zip(original_values, new_values)]
sharpe_ratio = np.mean(returns) / np.std(returns) * np.sqrt(252) # assuming daily returns
print('Sharpe Ratio: %.2f' % sharpe_ratio)
```

### 4. Максимальная просадка

Максимальная просадка — наибольшее снижение от пика к минимуму.

```python
def max_drawdown(equity_curve):
    i = np.argmax(np.maximum.accumulate(equity_curve) - equity_curve)
    j = np.argmax(equity_curve[:i])
    return (equity_curve[j] - equity_curve[i]) / equity_curve[j]

equity_curve = np.array([val.portfolio_value for val in cerebro.run()])
max_dd = max_drawdown(equity_curve)
print('Max Drawdown: %.2f%%' % (max_dd * 100))
```

## Типичные ошибки в бэктестинге

Хотя бэктестинг дает полезные инсайты, важно избегать следующих ошибок:

### 1. Look-ahead bias

Использование будущих данных при принятии решений искажает результаты.

### 2. Переобучение

Стратегия, подогнанная под историю, часто плохо работает в реальной торговле.

### 3. Survivorship bias

Исторические данные могут включать только выжившие активы, игнорируя исчезнувшие.

### 4. Игнорирование проскальзывания и комиссий

Это приводит к переоценке реальной эффективности стратегии.

## Продвинутые темы

### Walk-forward анализ

Методика, при которой данные разделяются на последовательные тренировочные и тестовые окна, имитируя движение времени.

### Обучение с подкреплением

Стратегии могут адаптироваться, обучаясь на результатах. Библиотеки вроде TensorFlow и PyTorch интегрируются с фреймворками бэктестинга.

### Генетические алгоритмы

Используются для оптимизации стратегий через моделирование естественного отбора.

## Заключение

Бэктестинг — незаменимый инструмент для алгоритмического трейдера. Python предоставляет богатый набор библиотек и инструментов, упрощающих разработку, тестирование и оптимизацию стратегий. При этом важно учитывать ограничения и избегать типичных ошибок, чтобы результаты были максимально близки к реальности.

Для дальнейшего изучения полезно обратиться к документации перечисленных библиотек и экспериментировать с различными стратегиями, источниками данных и метриками.
