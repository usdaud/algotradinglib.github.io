# Анализ скользящей Z-оценки

Анализ скользящей Z-оценки — статистический метод, широко применяемый в алгоритмической торговле для измерения относительного положения точки данных внутри скользящего окна недавних наблюдений. Он полезен для выявления состояний перекупленности или перепроданности, поиска возможностей возврата к среднему и принятия торговых решений на основе статистических порогов. В этом документе подробно рассматриваются концепция, методология, применения и реализация анализа скользящей Z-оценки в алгоритмической торговле.

## Понимание Z-оценки

Z-оценка, также известная как стандартизированная оценка, показывает, на сколько стандартных отклонений конкретная точка данных удалена от среднего набора данных. Она рассчитывается так:

\[ Z = \frac{(X - \mu)}{\sigma} \]

Где:
- \( Z \) — Z-оценка.
- \( X \) — значение точки данных.
- \( \mu \) — среднее значение набора данных.
- \( \sigma \) — стандартное отклонение набора данных.

Z-оценка помогает трейдерам понимать, насколько необычной или типичной является точка данных по сравнению с распределением. В торговле она часто используется для определения того, насколько цена актива существенно отклонилась от среднего, что дает подсказки о возможных входах или выходах.

## Скользящая Z-оценка

Скользящая Z-оценка применяет стандартный расчет Z-оценки к скользящему окну, то есть среднее (\( \mu \)) и стандартное отклонение (\( \sigma \)) постоянно обновляются по мере поступления новых данных и удаления старых. Такой динамический подход помогает адаптироваться к меняющимся рыночным условиям.

### Формула

Формула скользящей Z-оценки:

\[ Z_{t} = \frac{(X_{t} - \mu_{t,n})}{\sigma_{t,n}} \]

Где:
- \( Z_{t} \) — скользящая Z-оценка в момент времени \( t \).
- \( X_{t} \) — значение в момент \( t \).
- \( \mu_{t,n} \) — среднее последних \( n \) точек данных до времени \( t \).
- \( \sigma_{t,n} \) — стандартное отклонение последних \( n \) точек данных до времени \( t \).

### Расчет скользящих среднего и стандартного отклонения

Для расчета скользящей Z-оценки нужно обновлять среднее и стандартное отклонение для каждой новой точки данных с выбранным размером окна \( n \). Это можно сделать с помощью библиотек NumPy или Pandas в Python.

**Пример на Pandas:**

```python
import pandas as pd

def rolling_z_score(data, window):
    rolling_mean = data.rolling(window=window).mean()
    rolling_std = data.rolling(window=window).std(ddof=0)
    z_score = (data - rolling_mean) / rolling_std
    return z_score
```

## Применения в алгоритмической торговле

Анализ скользящей Z-оценки — универсальный инструмент, используемый в различных стратегиях алгоритмической торговли, включая:

### 1. Стратегии возврата к среднему

Стратегии возврата к среднему исходят из предположения, что цены активов колеблются вокруг среднего значения. Определяя существенные отклонения от среднего с помощью скользящей Z-оценки, трейдеры могут принимать решения о покупке или продаже, делая ставку на возврат цены к среднему.

Например, если скользящая Z-оценка актива превышает порог (например, +2), это может указывать на перекупленность или перепроданность и побуждать трейдера занять контр-трендовую позицию.

### 2. Статистический арбитраж

В статистическом арбитраже скользящие Z-оценки помогают выявлять пары активов или портфелей, которые временно оценены неверно относительно друг друга. Трейдеры используют схождение цен, продавая переоцененный актив и покупая недооцененный.

### 3. Управление рисками

Скользящие Z-оценки полезны и в управлении рисками. Отслеживая Z-оценку, трейдеры могут выявлять аномальные движения цены и корректировать позиции или параметры риска, чтобы снизить потенциальные потери.

## Реализация скользящей Z-оценки в алгоритмической торговле

Внедрение анализа скользящей Z-оценки включает сбор данных, предобработку, расчет и разработку стратегии. Ниже приведено пошаговое руководство:

### Шаг 1: Сбор данных

На первом этапе требуются исторические данные цен активов, которыми вы планируете торговать. Их можно получить у различных поставщиков, например Bloomberg, Alpha Vantage или Quandl.

Пример с Alpha Vantage:

```python
import requests

api_key = 'YOUR_API_KEY'
symbol = 'AAPL'
url = f'
response = requests.get(url)

with open(f'{symbol}_data.csv', 'wb') as file:
    file.write(response.content)
```

### Шаг 2: Предобработка данных

Очистите и предобработайте данные. Обычно это включает обработку пропусков, выбросов и нормализацию.

```python
import pandas as pd

data = pd.read_csv(f'{symbol}_data.csv')
data['timestamp'] = pd.to_datetime(data['timestamp'])
data = data.set_index('timestamp')
data = data.sort_index()

# Обработка пропусков
data = data.fillna(method='ffill').fillna(method='bfill')

# Нормализация данных при необходимости
# data['normalized'] = (data['adjusted_close'] - data['adjusted_close'].mean()) / data['adjusted_close'].std()
```

### Шаг 3: Расчет скользящей Z-оценки

Определите размер окна и вычислите скользящую Z-оценку для цен актива.

```python
window_size = 20  # Размер скользящего окна
data['rolling_z_score'] = rolling_z_score(data['adjusted_close'], window_size)
```

### Шаг 4: Разработка стратегии

Разработайте торговую стратегию на основе сигналов скользящей Z-оценки. Например, можно создать стратегию возврата к среднему, опираясь на значения Z-оценки.

```python
# Определение торговых сигналов по порогам Z-оценки
threshold = 2
data['signal'] = 0
data.loc[data['rolling_z_score'] > threshold, 'signal'] = -1  # Сигнал на продажу
data.loc[data['rolling_z_score'] < -threshold, 'signal'] = 1  # Сигнал на покупку

# Симуляция позиций и доходности
data['position'] = data['signal'].shift()
data['daily_return'] = data['adjusted_close'].pct_change()
data['strategy_return'] = data['position'] * data['daily_return']

# Расчет накопленной доходности
data['cumulative_strategy_return'] = (1 + data['strategy_return']).cumprod()
data['cumulative_market_return'] = (1 + data['daily_return']).cumprod()
```

### Шаг 5: Бэктестинг и оценка

Проведите бэктест стратегии на исторических данных и оцените ее результаты. Проанализируйте ключевые метрики, такие как накопленная доходность, коэффициент Шарпа и максимальная просадка.

```python
import matplotlib.pyplot as plt

# График накопленной доходности
plt.figure(figsize=(12, 6))
plt.plot(data['cumulative_strategy_return'], label='Доходность стратегии')
plt.plot(data['cumulative_market_return'], label='Доходность рынка')
plt.title('Накопленная доходность')
plt.legend()
plt.show()
```

### Шаг 6: Развертывание

После успешного бэктестинга разверните алгоритм в реальной торговой среде. Используйте потоки данных в реальном времени и интеграции с торговыми платформами, такими как MetaTrader, Interactive Brokers или Alpaca, чтобы исполнять сделки.

Пример с Alpaca:

```python
import alpaca_trade_api as tradeapi

api_key = 'YOUR_API_KEY'
api_secret = 'YOUR_API_SECRET'
base_url = '

api = tradeapi.REST(api_key, api_secret, base_url, api_version='v2')

# Информация по счету
account = api.get_account()
print(account)

# Исполнение сделок по сигналам
for index, row in data.iterrows():
    if row['signal'] == 1:
        api.submit_order(
            symbol=symbol,
            qty=10,
            side='buy',
            type='market',
            time_in_force='gtc'
        )
    elif row['signal'] == -1:
        api.submit_order(
            symbol=symbol,
            qty=10,
            side='sell',
            type='market',
            time_in_force='gtc'
        )
```

## Сложности и важные моменты

Реализация анализа скользящей Z-оценки в алгоритмической торговле сопряжена с рядом сложностей:

1. **Качество данных:** убедитесь, что исторические данные точны и чисты, иначе результаты будут искажены.
2. **Выбор параметров:** тщательно подберите размер окна и пороги Z-оценки, чтобы оптимизировать результаты стратегии.
3. **Рыночные условия:** учитывайте влияние меняющихся рыночных условий и адаптируйте стратегию при необходимости.
4. **Исполнение и проскальзывание:** учитывайте задержки исполнения и проскальзывание, которые могут снижать прибыльность стратегии.
5. **Управление рисками:** внедряйте устойчивые практики риск-менеджмента для защиты от потенциальных потерь.

## Заключение

Анализ скользящей Z-оценки — мощный статистический инструмент, который усиливает стратегии алгоритмической торговли, давая динамические инсайты о ценовых отклонениях и рыночных условиях. Понимание его применений и аккуратная реализация в торговых алгоритмах позволяют получить конкурентное преимущество и улучшить процесс принятия решений.

Для дополнительного чтения и практических примеров реализации изучите ресурсы поставщиков данных и торговых платформ, упомянутых в этом документе:

- Alpha Vantage
- Alpaca
- Interactive Brokers

Анализ скользящей Z-оценки остается важной частью количественных финансов и помогает трейдерам и инвесторам ориентироваться в сложности финансовых рынков.
