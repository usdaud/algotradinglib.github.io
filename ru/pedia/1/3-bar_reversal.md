# Трёхбаровый разворот

## Введение
Трёхбаровый разворот — это паттерн технического анализа, используемый преимущественно в алгоритмической торговле. Это тип ценового паттерна, который указывает на потенциальный разворот текущего тренда финансового инструмента. Хотя он обычно применяется в стратегиях ручной торговли, его структура, основанная на правилах, делает его идеальным для интеграции в автоматизированные торговые системы. Эта стратегия популярна среди внутридневных трейдеров и свинг-трейдеров, стремящихся поймать быстрые развороты на рынке.

## Анатомия паттерна трёхбарового разворота
Паттерн трёхбарового разворота состоит из трёх последовательных баров (свечей):

1. **Первый бар**: Бар, задающий тренд, который может быть либо бычьим, либо медвежьим.
2. **Второй бар**: Меньший бар, который продолжает движение в том же направлении, что и первый бар, но с меньшим импульсом.
3. **Третий бар**: Разворотный бар, который движется в противоположном направлении от первых двух баров, сигнализируя о развороте.

### Бычий трёхбаровый разворот
1. **Первый бар**: Медвежий бар, указывающий на нисходящий тренд.
2. **Второй бар**: Меньший медвежий бар, который продолжает нисходящий тренд, но с меньшим импульсом.
3. **Третий бар**: Бычий бар, который закрывается выше максимума первого бара.

### Медвежий трёхбаровый разворот
1. **Первый бар**: Бычий бар, указывающий на восходящий тренд.
2. **Второй бар**: Меньший бычий бар, который продолжает восходящий тренд, но с меньшим импульсом.
3. **Третий бар**: Медвежий бар, который закрывается ниже минимума первого бара.

## Математическая формулировка
Паттерн может быть математически выражен для алгоритмической реализации. Обозначим цену открытия, цену закрытия, максимум и минимум бара во время \( t \) как \( O_t \), \( C_t \), \( H_t \), \( L_t \) соответственно.

### Условия бычьего разворота:
1. \( C_{t-2} < O_{t-2} \) (Медвежий первый бар)
2. \( C_{t-1} < C_{t-2} \) и \( C_{t-1} > L_{t-2} \) (Медвежий второй бар с меньшим импульсом)
3. \( C_{t} > O_{t} \) и \( C_{t} > H_{t-2} \) (Бычий разворотный бар)

### Условия медвежьего разворота:
1. \( C_{t-2} > O_{t-2} \) (Бычий первый бар)
2. \( C_{t-1} > C_{t-2} \) и \( C_{t-1} < H_{t-2} \) (Бычий второй бар с меньшим импульсом)
3. \( C_{t} < O_{t} \) и \( C_{t} < L_{t-2} \) (Медвежий разворотный бар)

## Пример
Рассмотрим акцию, торгующуюся по различным ценовым точкам в течение трёх последовательных периодов:

### Бычий разворот:
* **День 1**: Open = $100, Close = $95, High = $101, Low = $94
* **День 2**: Open = $94, Close = $92, High = $96, Low = $91
* **День 3**: Open = $93, Close = $97, High = $98, Low = $92

В этом примере цена закрытия третьего дня ($97) выше максимума первого дня ($101), подтверждая бычий трёхбаровый разворот.

### Медвежий разворот:
* **День 1**: Open = $100, Close = $105, High = $106, Low = $99
* **День 2**: Open = $104, Close = $107, High = $108, Low = $103
* **День 3**: Open = $106, Close = $102, High = $107, Low = $100

Здесь цена закрытия третьего дня ($102) ниже минимума первого дня ($100), указывая на медвежий трёхбаровый разворот.

## Применение в алгоритмической торговле
Алгоритмические трейдеры используют паттерны трёхбарового разворота для автоматизации процесса принятия решений. Паттерн включается в торговые алгоритмы для:

1. **Идентификации точек входа**: Завершение паттерна трёхбарового разворота рассматривается как сигнал для входа в сделку в направлении разворота.
2. **Установки стоп-лосс ордеров**: Для управления рисками стоп-лосс ордера часто устанавливаются на максимуме (для медвежьих разворотов) или минимуме (для бычьих разворотов) разворотного бара.
3. **Оптимизации алгоритмов**: Бэктестирование на исторических данных используется для оптимизации параметров и обеспечения эффективности стратегии трёхбарового разворота.

## Кодирование стратегии трёхбарового разворота

### Пример на Python с `pandas`
```python
import pandas as pd

def identify_3_bar_reversal(data):
    signals = []

    for i in range(2, len(data)):
        first_bar = data.iloc[i-2]
        second_bar = data.iloc[i-1]
        third_bar = data.iloc[i]

        # Check Bullish Reversal
        if (first_bar['Close'] < first_bar['Open'] and
            second_bar['Close'] < first_bar['Close'] and
            third_bar['Close'] > third_bar['Open'] and
            third_bar['Close'] > first_bar['High']):
            signals.append((data.index[i], "BUY"))

        # Check Bearish Reversal
        elif (first_bar['Close'] > first_bar['Open'] and
              second_bar['Close'] > first_bar['Close'] and
              third_bar['Close'] < third_bar['Open'] and
              third_bar['Close'] < first_bar['Low']):
            signals.append((data.index[i], "SELL"))

    return signals

# Sample Data
data = pd.DataFrame{
    'Open': [100, 94, 93, 100, 104, 106],
    'Close': [95, 92, 97, 105, 107, 102],
    'High': [101, 96, 98, 106, 108, 107],
    'Low': [94, 91, 92, 99, 103, 100]
}, index=pd.date_range(start='2023-01-01', periods=6))

signals = identify_3_bar_reversal(data)
print(signals)
```

## Ограничения трёхбарового разворота
Хотя паттерн эффективен, трёхбаровый разворот имеет свои ограничения:
1. **Ложные сигналы**: Как и все торговые паттерны, он может генерировать ложные сигналы, приводящие к потенциальным убыткам.
2. **Чувствительность к параметрам**: Эффективность может варьироваться в зависимости от различных рыночных условий и типов инструментов.
3. **Запаздывающий индикатор**: Будучи разворотным паттерном, он отстает от текущего ценового движения и может пропустить оптимальные точки входа или выхода.

## Практический пример: Интеграция с QuantConnect
QuantConnect — это облачная платформа, предоставляющая инфраструктуру для алгоритмической торговли, способная реализовать различные торговые стратегии, включая паттерн трёхбарового разворота. Пользователи могут писать код на Python, C# или F# для бэктестирования и развертывания своих стратегий.

### Пример реализации:
```python
from AlgorithmImports import *

class ThreeBarReversalAlgorithm(QCAlgorithm):
    def Initialize(self):
        self.SetStartDate(2022, 1, 1)  # Set Start Date
        self.SetEndDate(2022, 12, 31)  # Set End Date
        self.SetCash(100000)  # Set Strategy Cash
        self.AddEquity("SPY", Resolution.Daily)
        self.window = RollingWindowQuoteBar

    def OnData(self, data):
        self.window.Add(data["SPY"])

        if self.window.IsReady:
            first_bar = self.window[2]
            second_bar = self.window[1]
            third_bar = self.window[0]

            # Check for Bullish Reversal
            if (first_bar.Close < first_bar.Open and
                second_bar.Close < first_bar.Close and
                third_bar.Close > third_bar.Open and
                third_bar.Close > first_bar.High):
                self.SetHoldings("SPY", 1)
                self.Debug(f"BUY Signal on {self.Time}")

            # Check for Bearish Reversal
            elif (first_bar.Close > first_bar.Open and
                  second_bar.Close > first_bar.Close and
                  third_bar.Close < third_bar.Open and
                  third_bar.Close < first_bar.Low):
                self.SetHoldings("SPY", -1)
                self.Debug(f"SELL Signal on {self.Time}")
```

## Заключение
Трёхбаровый разворот — это мощный паттерн для обнаружения потенциальных разворотов тренда на финансовых рынках. Его структурированная природа облегчает интеграцию в алгоритмические торговые системы, где он может использоваться для генерации сигналов покупки и продажи на основе предопределенных критериев. Однако важно учитывать его ограничения и тщательно проводить бэктестирование для обеспечения его эффективности в различных рыночных условиях.

Используя платформы, такие как QuantConnect, трейдеры могут разрабатывать, тестировать и развертывать сложные стратегии, включающие паттерн трёхбарового разворота, согласовывая автоматизированные решения со своими торговыми целями.
